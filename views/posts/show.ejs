<% layout('layout/boilerplate') %>

<%- include('../partials/panel-left')%>

<div class="col-md-6">
    <div class="card mb-3">
        <div class="row ">
            <div class="col">
                <div class="card-body">
                    <% post.tags.forEach((tag) => { %>
                        <a href="/posts/tagged/<%=encodeURIComponent(tag)%> "><div class="btn btn-dark btn-sm tags"><%=tag%></div></a>
                    <% }) %>
                    <h5 class="card-title mb-3">
                        <b><%= post.title %></b>
                    </h5>
                    <div id="postCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner mb-3">
                            <% post.images.forEach((img, i) => { %>
                            <div class="carousel-item <%= i === 0 ? 'active' : '' %> border border-secondary">
                                <img src="<%=img.url%>" class="d-block w-100" alt="...">
                            </div>
                            <% }) %>
                        </div>
                    </div>
                    <!-- buttons -->
                    <%- include('../partials/post-buttons.ejs', { post, currentUser }) -%>
                    <!-- buttons -->
                </div>
            </div>
        </div>
        <ul class="list-group list-group-flush">
            <li class="list-group-item">Posted at: <%=moment(post.createdAt).format('MMMM Do YYYY')%></li>
            <li class="list-group-item">OP:
                <a href="/users/<%=post.author._id%>" class="text-decoration-none text-dark">
                    <b>@<%=post.author.username%></b>
                </a>
            </li>
        </ul>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">
                <%=post.comments.length%> Comments
            </h5>
            <hr>
            <form action="/posts/<%=post._id%>/comments/" method="POST" novalidate class="mb-3 form-validation">
                <div class="mb-3">
                    <% if(currentUser) { %>
                    <textarea class="form-control mb-3" name="comment[body]" id="body" cols="30" rows="4"
                        placeholder="Write a comment..." required></textarea>
                    <div class="invalid-feedback">
                        Must write a comment
                    </div>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-success">Post</button>
                    </div>
                    <% } else { %>
                    <textarea class="form-control mb-3" name="comment[body]" id="body" cols="30" rows="4"
                        placeholder="Login to comment a post..." required disabled></textarea>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-success" disabled>Post</button>
                    </div>
                    <% } %>
                </div>
            </form>
            <div class="card mb-3">
                <% for(let comment of post.comments) { %>
                <div class="card-body">
                    <hr>
                    <h5>
                        <a class="text-decoration-none text-dark" href="/users/<%=comment.author._id%> ">
                            <b>@<%=comment.author.username%></b>
                        </a>
                            <% if(comment.author._id.equals(post.author._id)) { %>
                                <b>(OP)</b>
                            <% } %>
                    </h5>
                    <p class="card-text">
                        <%= comment.body %>
                    </p>
                    <% if(currentUser && currentUser._id.equals(comment.author._id)) { %>
                    <form class="d-inline" action="/posts/<%=post._id%>/comments/<%=comment._id%>?_method=DELETE" method="POST">
                        <button class="btn btn-danger">Delete comment</button>
                    </form>
                    <% } %>
                </div>
                <% } %>
            </div>
        </div>
    </div>
</div>
<%- include('../partials/panel-right')%>
